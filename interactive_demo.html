<!DOCTYPE html>
<html lang="en">
  <head>
    <script>
      // Suppress Chrome extension runtime errors
      if (
        typeof chrome !== "undefined" &&
        chrome.runtime &&
        chrome.runtime.onMessage
      ) {
        chrome.runtime.onMessage.addListener(function (
          request,
          sender,
          sendResponse
        ) {
          // Always respond to prevent port closure errors
          sendResponse({ status: "received" });
          return true;
        });
      }

      // Suppress console errors for cleaner demo
      const originalError = console.error;
      console.error = function (...args) {
        const message = args.join(" ");
        // Filter out Chrome extension errors
        if (
          !message.includes("runtime.lastError") &&
          !message.includes("message port closed")
        ) {
          originalError.apply(console, args);
        }
      };
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transnational AQMS - ADK Hackathon Demo</title>
    <!-- Inter font for modern look -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      html,
      body {
        font-family: "Inter", "Segoe UI", Arial, sans-serif;
        background: linear-gradient(135deg, #2196f3 0%, #4caf50 100%);
        color: #fff;
        min-height: 100vh;
        margin: 0;
        padding: 0;
      }
      nav {
        background: rgba(33, 33, 33, 0.98);
        box-shadow: 0 2px 12px rgba(33, 33, 33, 0.08);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .brand-logo {
        font-weight: 700;
        letter-spacing: 1px;
        font-size: 2.1em;
        color: #fff !important;
        text-shadow: 0 2px 8px rgba(33, 33, 33, 0.12);
      }
      .nav-links {
        display: flex;
        gap: 2em;
        align-items: center;
        margin-right: 2em;
      }
      .nav-links a {
        color: #fff;
        font-weight: 500;
        text-decoration: none;
        font-size: 1.1em;
        opacity: 0.92;
        transition: color 0.2s;
      }
      .nav-links a:hover,
      .nav-links a:focus {
        color: #ffd600;
        outline: none;
      }
      .impact-number {
        font-size: 3.2em;
        font-weight: 700;
        color: #ffd600;
        letter-spacing: 1px;
        margin-bottom: 0.2em;
        text-shadow: 0 2px 8px rgba(33, 33, 33, 0.1);
      }
      .impact-label {
        font-size: 1.2em;
        color: #fff;
        opacity: 0.95;
        margin-bottom: 1.5em;
      }
      .glass-card {
        background: rgba(255, 255, 255, 0.13);
        border-radius: 22px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1.5px solid rgba(255, 255, 255, 0.18);
        padding: 2.2em 1.5em 1.5em 1.5em;
        margin: 1em 0.5em;
        min-width: 320px;
        max-width: 410px;
        flex: 1 1 350px;
        position: relative;
        transition: box-shadow 0.2s, transform 0.2s;
        overflow: hidden;
      }
      .glass-card:hover,
      .glass-card:focus-within {
        box-shadow: 0 12px 36px 0 rgba(31, 38, 135, 0.22);
        transform: translateY(-2px) scale(1.02);
      }
      .card-header {
        display: flex;
        align-items: center;
        gap: 0.7em;
        margin-bottom: 0.7em;
      }
      .card-title {
        font-size: 1.25em;
        font-weight: 600;
        color: #ffd600;
        letter-spacing: 0.5px;
      }
      .status-dot {
        width: 13px;
        height: 13px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 0.5em;
        background: #43a047;
        box-shadow: 0 0 6px #43a04799;
      }
      .status-dot.warning {
        background: #ffd600;
        box-shadow: 0 0 6px #ffd60099;
      }
      .status-dot.error {
        background: #e53935;
        box-shadow: 0 0 6px #e5393599;
      }
      .pill-btn {
        border-radius: 999px;
        background: linear-gradient(90deg, #43a047 0%, #2196f3 100%);
        color: #fff;
        font-weight: 600;
        box-shadow: 0 4px 16px rgba(33, 150, 243, 0.13);
        transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
        padding: 0.8em 2.2em;
        font-size: 1.1em;
        letter-spacing: 0.5px;
        border: none;
        outline: none;
        margin: 0.5em 0.4em 0.5em 0;
        display: inline-flex;
        align-items: center;
        gap: 0.5em;
        cursor: pointer;
      }
      .pill-btn:active,
      .pill-btn:focus {
        background: linear-gradient(90deg, #2196f3 0%, #43a047 100%);
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 8px 24px rgba(33, 150, 243, 0.18);
      }
      .pill-btn.red {
        background: linear-gradient(90deg, #e53935 0%, #ffd600 100%);
        color: #fff;
      }
      .pill-btn.yellow {
        background: linear-gradient(90deg, #ffd600 0%, #ff9800 100%);
        color: #333;
      }
      .pill-btn.blue {
        background: linear-gradient(90deg, #2196f3 0%, #43a047 100%);
      }
      .pill-btn .material-icons {
        font-size: 1.2em;
        vertical-align: middle;
      }
      .gauge-canvas {
        display: block;
        margin: 0 auto 10px auto;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        width: 160px !important;
        height: 160px !important;
        max-width: 100%;
      }
      .metrics {
        margin: 0.7em 0 0.2em 0;
        font-size: 1.08em;
        color: #fff;
        opacity: 0.97;
      }
      .leaflet-container {
        border-radius: 18px;
        margin: 0 auto;
        max-width: 900px;
        height: 340px;
        margin-bottom: 30px;
        box-shadow: 0 4px 24px rgba(33, 33, 33, 0.13);
      }
      .snackbar {
        position: fixed;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        min-width: 280px;
        background: #e53935;
        color: #fff;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 1.1em;
        z-index: 9999;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .snackbar.success {
        background: #43a047;
      }
      .fab {
        position: fixed;
        right: 24px;
        bottom: 32px;
        background: linear-gradient(90deg, #2196f3 0%, #43a047 100%);
        color: #fff;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 24px rgba(33, 150, 243, 0.18);
        font-size: 2.2em;
        cursor: pointer;
        z-index: 1001;
        transition: background 0.2s, box-shadow 0.2s;
      }
      .fab:active,
      .fab:focus {
        background: linear-gradient(90deg, #43a047 0%, #2196f3 100%);
        box-shadow: 0 8px 32px rgba(33, 150, 243, 0.22);
      }
      @media (max-width: 900px) {
        .dashboard-grid {
          flex-direction: column;
          align-items: center;
        }
        .leaflet-container {
          height: 220px;
        }
        .fab {
          right: 12px;
          bottom: 18px;
          width: 54px;
          height: 54px;
          font-size: 1.7em;
        }
      }
      @media (max-width: 600px) {
        .brand-logo {
          font-size: 1.3em;
        }
        .impact-number {
          font-size: 2em;
        }
        .glass-card {
          min-width: 90vw;
          max-width: 98vw;
          padding: 1.2em 0.7em;
        }
        .dashboard-grid {
          gap: 0.5em;
        }
      }
      /* Loading spinner */
      .spinner {
        display: inline-block;
        width: 28px;
        height: 28px;
        border: 3px solid #fff;
        border-radius: 50%;
        border-top: 3px solid #2196f3;
        animation: spin 1s linear infinite;
        vertical-align: middle;
        margin-left: 0.7em;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 1em;
        "
      >
        <span class="brand-logo">Transnational AQMS</span>
        <div class="nav-links" id="nav-links">
          <a href="#dashboard">Dashboard</a>
          <a href="#map">Map</a>
          <a href="#reports" id="reports-link">Reports</a>
          <a href="#settings" id="settings-link">Settings</a>
        </div>
      </div>
    </nav>
    <div class="container" style="max-width: 1200px; margin: 0 auto">
      <div class="center-align" style="margin: 32px 0 10px 0">
        <div class="impact-number">58M</div>
        <div class="impact-label">
          People Protected Across Bangladesh-India Border
        </div>
      </div>
      <div class="center-align" style="margin-bottom: 20px">
        <button
          class="pill-btn blue"
          id="refresh-btn"
          aria-label="Refresh Data"
        >
          <i class="material-icons left">refresh</i>REFRESH DATA
        </button>
        <span
          id="last-updated"
          style="margin-left: 20px; font-size: 1.1em; color: #ffd600"
        ></span>
      </div>
      <div
        class="dashboard-grid"
        style="
          display: flex;
          flex-wrap: wrap;
          gap: 24px;
          justify-content: center;
          margin-bottom: 30px;
        "
      >
        <!-- Bangladesh Agent Card -->
        <div
          class="glass-card"
          tabindex="0"
          aria-label="Bangladesh Agent Panel"
        >
          <div class="card-header">
            <span class="material-icons" style="color: #43a047">flag</span>
            <span class="card-title">BD Bangladesh Agent (Sequential)</span>
            <span class="status-dot" id="bd-status-dot"></span>
          </div>
          <div class="metrics" id="bd-metrics"></div>
          <canvas
            id="bd-gauge"
            class="gauge-canvas"
            width="160"
            height="160"
            aria-label="PM2.5 Gauge for Dhaka"
            tabindex="0"
          ></canvas>
          <div
            style="
              margin-top: 1em;
              display: flex;
              gap: 0.7em;
              justify-content: center;
            "
          >
            <button
              class="pill-btn"
              onclick="collectData('bangladesh')"
              aria-label="Collect Data"
            >
              <i class="material-icons left">cloud_download</i>COLLECT DATA
            </button>
            <button
              class="pill-btn"
              onclick="checkHealth('bangladesh')"
              aria-label="Health Check"
            >
              <i class="material-icons left">favorite</i>HEALTH CHECK
            </button>
          </div>
        </div>
        <!-- India Agent Card -->
        <div class="glass-card" tabindex="0" aria-label="India Agent Panel">
          <div class="card-header">
            <span class="material-icons" style="color: #43a047">flag</span>
            <span class="card-title">IN India Agent (Parallel)</span>
            <span class="status-dot" id="in-status-dot"></span>
          </div>
          <div class="metrics" id="in-metrics"></div>
          <canvas
            id="in-gauge"
            class="gauge-canvas"
            width="160"
            height="160"
            aria-label="PM2.5 Gauge for Kolkata"
            tabindex="0"
          ></canvas>
          <div
            style="
              margin-top: 1em;
              display: flex;
              gap: 0.7em;
              justify-content: center;
            "
          >
            <button
              class="pill-btn"
              onclick="collectData('india')"
              aria-label="Analyze Weather"
            >
              <i class="material-icons left">wb_sunny</i>ANALYZE WEATHER
            </button>
            <button
              class="pill-btn"
              onclick="checkHealth('india')"
              aria-label="Health Check"
            >
              <i class="material-icons left">favorite</i>HEALTH CHECK
            </button>
          </div>
        </div>
        <!-- Orchestrator Card -->
        <div
          class="glass-card"
          tabindex="0"
          aria-label="Regional Orchestrator Panel"
        >
          <div class="card-header">
            <span class="material-icons" style="color: #2196f3">public</span>
            <span class="card-title">Regional Orchestrator (Loop)</span>
            <span class="status-dot" id="orchestrator-status-dot"></span>
          </div>
          <div class="metrics" id="orchestrator-metrics"></div>
          <canvas
            id="orchestrator-gauge"
            class="gauge-canvas"
            width="160"
            height="160"
            aria-label="Orchestrator PM2.5 Gauge"
            tabindex="0"
          ></canvas>
          <div
            style="
              margin-top: 1em;
              display: flex;
              gap: 0.7em;
              justify-content: center;
            "
          >
            <button
              class="pill-btn deep-purple"
              onclick="coordinate()"
              aria-label="Coordinate"
            >
              <i class="material-icons left">sync</i>COORDINATE
            </button>
            <button
              class="pill-btn"
              onclick="checkHealth('orchestrator')"
              aria-label="Health Check"
            >
              <i class="material-icons left">favorite</i>HEALTH CHECK
            </button>
          </div>
        </div>
      </div>
      <!-- Interactive Map -->
      <div
        id="map"
        class="z-depth-2"
        style="margin: 30px 0 10px 0; width: 100%; height: 340px"
      ></div>
      <div
        id="emergency-section"
        style="max-width: 900px; margin: 0 auto 24px auto"
      >
        <div
          class="glass-card"
          tabindex="0"
          aria-label="Emergency Scenario Demo"
          style="margin-top: 18px"
        >
          <div class="card-header">
            <span class="material-icons" style="color: #e53935">warning</span>
            <span class="card-title" style="color: #e53935"
              >Emergency Scenario Demo</span
            >
          </div>
          <div style="margin-bottom: 0.7em">
            Simulate a high pollution episode and cross-border coordination.
          </div>
          <div style="margin-bottom: 1em">
            <button
              class="pill-btn red"
              onclick="simulateEmergency()"
              aria-label="Trigger Emergency"
            >
              <i class="material-icons left">report_problem</i>TRIGGER EMERGENCY
            </button>
            <button
              class="pill-btn yellow"
              onclick="showMetrics()"
              aria-label="Show Metrics"
            >
              <i class="material-icons left">insights</i>SHOW METRICS
            </button>
          </div>
          <div
            id="emergency-response"
            class="metrics"
            style="display: none"
          ></div>
        </div>
        <div
          class="dashboard-grid"
          id="metrics-display"
          style="
            display: none;
            gap: 18px;
            justify-content: center;
            margin-top: 18px;
          "
        >
          <div class="glass-card" style="min-width: 180px; text-align: center">
            <div class="impact-number" style="font-size: 2.1em">&lt; 1hr</div>
            <div class="impact-label">Alert Response Time</div>
          </div>
          <div class="glass-card" style="min-width: 180px; text-align: center">
            <div class="impact-number" style="font-size: 2.1em">97%</div>
            <div class="impact-label">Improvement vs Legacy</div>
          </div>
          <div class="glass-card" style="min-width: 180px; text-align: center">
            <div class="impact-number" style="font-size: 2.1em">1.2M</div>
            <div class="impact-label">Requests/Hour Capacity</div>
          </div>
          <div class="glass-card" style="min-width: 180px; text-align: center">
            <div class="impact-number" style="font-size: 2.1em">&lt; 1min</div>
            <div class="impact-label">Cross-Border Sync</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Floating Action Button for mobile -->
    <div
      class="fab"
      id="fab-refresh"
      aria-label="Refresh Data"
      tabindex="0"
      style="display: none"
    >
      <span class="material-icons">refresh</span>
    </div>
    <!-- Snackbar for feedback -->
    <div
      id="snackbar"
      class="snackbar"
      role="alert"
      aria-live="assertive"
    ></div>
    <div
      id="reports-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(33, 33, 33, 0.45);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        id="reports-modal-content"
        style="
          background: rgba(255, 255, 255, 0.13);
          backdrop-filter: blur(12px);
          border-radius: 18px;
          box-shadow: 0 8px 32px rgba(31, 38, 135, 0.18);
          padding: 2.2em 1.5em 1.5em 1.5em;
          max-width: 700px;
          width: 95vw;
          max-height: 90vh;
          overflow: auto;
          position: relative;
        "
      >
        <button
          onclick="closeReportsModal()"
          aria-label="Close Reports"
          style="
            position: absolute;
            top: 18px;
            right: 18px;
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
          "
        >
          <span class="material-icons">close</span>
        </button>
        <h2 style="color: #ffd600; margin-top: 0; margin-bottom: 0.7em">
          Recent Data Reports
        </h2>
        <div id="reports-table-area" style="margin-bottom: 1.2em"></div>
        <button
          class="pill-btn blue"
          onclick="downloadCSV()"
          aria-label="Download CSV"
        >
          <i class="material-icons left">download</i>DOWNLOAD CSV
        </button>
      </div>
    </div>
    <div
      id="settings-modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(33, 33, 33, 0.45);
        z-index: 2100;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        id="settings-modal-content"
        style="
          background: rgba(255, 255, 255, 0.13);
          backdrop-filter: blur(12px);
          border-radius: 18px;
          box-shadow: 0 8px 32px rgba(31, 38, 135, 0.18);
          padding: 2.2em 1.5em 1.5em 1.5em;
          max-width: 420px;
          width: 95vw;
          max-height: 90vh;
          overflow: auto;
          position: relative;
        "
      >
        <button
          onclick="closeSettingsModal()"
          aria-label="Close Settings"
          style="
            position: absolute;
            top: 18px;
            right: 18px;
            background: none;
            border: none;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
          "
        >
          <span class="material-icons">close</span>
        </button>
        <h2 style="color: #ffd600; margin-top: 0; margin-bottom: 0.7em">
          Settings
        </h2>
        <form id="settings-form" autocomplete="off" style="color: #fff">
          <div style="margin-bottom: 1.2em">
            <label for="theme-toggle" style="font-weight: 600">Theme:</label
            ><br />
            <select
              id="theme-toggle"
              style="
                width: 100%;
                padding: 0.5em;
                border-radius: 8px;
                margin-top: 0.3em;
              "
            >
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
          <div style="margin-bottom: 1.2em">
            <label for="refresh-interval" style="font-weight: 600"
              >Data Refresh Interval:</label
            ><br />
            <select
              id="refresh-interval"
              style="
                width: 100%;
                padding: 0.5em;
                border-radius: 8px;
                margin-top: 0.3em;
              "
            >
              <option value="15000">15 seconds</option>
              <option value="30000">30 seconds</option>
              <option value="60000">1 minute</option>
              <option value="300000">5 minutes</option>
            </select>
          </div>
          <div style="margin-bottom: 1.2em">
            <label for="alert-threshold" style="font-weight: 600"
              >Alert Threshold (PM2.5):</label
            ><br />
            <input
              id="alert-threshold"
              type="number"
              min="1"
              max="500"
              step="1"
              value="150"
              style="
                width: 100%;
                padding: 0.5em;
                border-radius: 8px;
                margin-top: 0.3em;
              "
            />
          </div>
          <button
            type="submit"
            class="pill-btn blue"
            style="width: 100%; margin-top: 1em"
          >
            Save Settings
          </button>
        </form>
      </div>
    </div>
    <script>
      // --- Chart.js Gauge Helper ---
      function renderGauge(canvasId, value, max, label, color) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        if (window[canvasId + "_chart"]) window[canvasId + "_chart"].destroy();
        window[canvasId + "_chart"] = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [label, ""],
            datasets: [
              {
                data: [value, Math.max(0, max - value)],
                backgroundColor: [color, "#eee"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: "80%",
            animation: { animateRotate: true, duration: 900 },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
              title: {
                display: true,
                text:
                  value !== null && value !== undefined
                    ? value + " µg/m³"
                    : "--",
                color: color,
                font: { size: 22, weight: "bold" },
              },
            },
          },
        });
      }
      // --- Snackbar Helper ---
      function showSnackbar(msg, success = false) {
        const bar = document.getElementById("snackbar");
        bar.textContent = msg;
        bar.className = "snackbar" + (success ? " success" : "");
        bar.style.display = "block";
        setTimeout(() => {
          bar.style.display = "none";
        }, 3500);
      }
      // --- Map Helper ---
      let map, bdMarker, inMarker;
      let mapInitialized = false;

      // Initialize map when Google Maps API is ready
      function initMap() {
        if (!mapInitialized && typeof google !== "undefined" && google.maps) {
          map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 23.2, lng: 89.5 },
            zoom: 6,
          });
          mapInitialized = true;
          console.log("Google Maps initialized successfully");
        }
      }

      // Remove Leaflet logic and use Google Maps API
      function renderMap(bdData, inData) {
        console.log("renderMap called with:", { bdData, inData });

        // Wait for Google Maps API to be ready
        if (!mapInitialized) {
          if (typeof google !== "undefined" && google.maps) {
            initMap();
          } else {
            console.log("Google Maps API not ready yet, retrying...");
            setTimeout(() => renderMap(bdData, inData), 100);
            return;
          }
        }

        console.log("Map initialized, creating markers...");

        // Remove old markers
        if (bdMarker) {
          bdMarker.setMap(null);
        }
        if (inMarker) {
          inMarker.setMap(null);
        }

        // Add Bangladesh marker
        if (bdData && bdData.pm25 !== undefined) {
          console.log("Creating Dhaka marker with PM2.5:", bdData.pm25);
          bdMarker = new google.maps.Marker({
            position: { lat: 23.8103, lng: 90.4125 },
            map: map,
            title: `Dhaka PM2.5: ${bdData.pm25 ?? "--"}`,
            label: {
              text: "Dhaka",
              color: getAQIColor(bdData.pm25),
              fontWeight: "bold",
              fontSize: "14px",
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 18, // Increased size for visibility
              fillColor: getAQIColor(bdData.pm25),
              fillOpacity: 0.9,
              strokeWeight: 2,
              strokeColor: "#333",
            },
          });
          console.log("Dhaka marker created:", bdMarker);
          const infoWindow = new google.maps.InfoWindow({
            content:
              `<b>Dhaka</b><br>PM2.5: ${bdData.pm25 ?? "--"} µg/m³` +
              `<br>AQI: ${bdData.aqi ?? "--"}`,
          });
          bdMarker.addListener("click", () => {
            infoWindow.open(map, bdMarker);
          });
        } else {
          console.log("No Dhaka data available:", bdData);
        }

        // Add Kolkata marker
        if (inData && inData.pm25 !== undefined) {
          console.log("Creating Kolkata marker with PM2.5:", inData.pm25);
          inMarker = new google.maps.Marker({
            position: { lat: 22.5726, lng: 88.3639 },
            map: map,
            title: `Kolkata PM2.5: ${inData.pm25 ?? "--"}`,
            label: {
              text: "Kolkata",
              color: getAQIColor(inData.pm25),
              fontWeight: "bold",
              fontSize: "14px",
            },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 18, // Increased size for visibility
              fillColor: getAQIColor(inData.pm25),
              fillOpacity: 0.9,
              strokeWeight: 2,
              strokeColor: "#333",
            },
          });
          console.log("Kolkata marker created:", inMarker);
          const infoWindow = new google.maps.InfoWindow({
            content:
              `<b>Kolkata</b><br>PM2.5: ${inData.pm25 ?? "--"} µg/m³` +
              `<br>AQI: ${inData.aqi ?? "--"}`,
          });
          inMarker.addListener("click", () => {
            infoWindow.open(map, inMarker);
          });
        } else {
          console.log("No Kolkata data available:", inData);
        }
      }
      function getAQIColor(pm25) {
        if (pm25 == null) return "#bdbdbd";
        if (pm25 <= 50) return "#43a047"; // Good
        if (pm25 <= 100) return "#ffd600"; // Moderate
        if (pm25 <= 150) return "#ff9800"; // Unhealthy for Sensitive
        if (pm25 <= 200) return "#e53935"; // Unhealthy
        return "#6a1b9a"; // Very Unhealthy
      }
      // --- Data Fetching ---
      const endpoints = {
        bangladesh: "/api/air-quality/dhaka",
        india: "/api/air-quality/kolkata",
        orchestrator: "/orchestrate",
        health: (service) => `/health`,
      };
      let lastData = { bd: null, in: null, orchestrator: null };
      let lastUpdated = null;
      let loading = false;
      async function fetchAgentData(agent) {
        try {
          const resp = await fetch(endpoints[agent]);
          const data = await resp.json();
          if (data.status !== "success") throw new Error("Failed to fetch");
          return data.data; // Extract the data from the response
        } catch (e) {
          showSnackbar(`Failed to fetch ${agent} data.`, false);
          return null;
        }
      }
      async function updateAllData(showFeedback = false) {
        if (loading) return;
        loading = true;
        showLoading(true);
        const [bd, ind] = await Promise.all([
          fetchAgentData("bangladesh"),
          fetchAgentData("india"),
        ]);
        lastData.bd = bd;
        lastData.in = ind;
        lastUpdated = new Date();
        renderAgentPanels();
        renderMap(bd, ind);
        if (showFeedback) showSnackbar("Data refreshed!", true);
        document.getElementById("last-updated").textContent = lastUpdated
          ? `Last updated: ${lastUpdated.toLocaleTimeString()}`
          : "";
        showLoading(false);
        loading = false;
      }
      function renderAgentPanels() {
        // Bangladesh
        const bd = lastData.bd || {};
        renderGauge(
          "bd-gauge",
          bd.pm25 ?? 0,
          300,
          "PM2.5",
          getAQIColor(bd.pm25)
        );
        document.getElementById("bd-metrics").innerHTML = `
          <b>City:</b> ${bd.city ?? "Dhaka"}<br>
          <b>PM2.5:</b> ${bd.pm25 ?? "--"} µg/m³<br>
          <b>AQI:</b> ${bd.aqi ?? "--"}<br>
          <b>Temperature:</b> ${bd.temperature ?? "--"} °C<br>
          <b>Humidity:</b> ${bd.humidity ?? "--"}%<br>
          <b>Pressure:</b> ${bd.pressure ?? "--"} hPa<br>
          <b>Wind Speed:</b> ${bd.wind_speed ?? "--"} m/s<br>
          <b>Time:</b> ${bd.time ?? "--"}
        `;
        document.getElementById("bd-status-dot").className =
          "status-dot " + getStatusClass(bd.pm25);
        // India
        const ind = lastData.in || {};
        renderGauge(
          "in-gauge",
          ind.pm25 ?? 0,
          300,
          "PM2.5",
          getAQIColor(ind.pm25)
        );
        document.getElementById("in-metrics").innerHTML = `
          <b>City:</b> ${ind.city ?? "Kolkata"}<br>
          <b>PM2.5:</b> ${ind.pm25 ?? "--"} µg/m³<br>
          <b>AQI:</b> ${ind.aqi ?? "--"}<br>
          <b>Temperature:</b> ${ind.temperature ?? "--"} °C<br>
          <b>Humidity:</b> ${ind.humidity ?? "--"}%<br>
          <b>Pressure:</b> ${ind.pressure ?? "--"} hPa<br>
          <b>Wind Speed:</b> ${ind.wind_speed ?? "--"} m/s<br>
          <b>Time:</b> ${ind.time ?? "--"}
        `;
        document.getElementById("in-status-dot").className =
          "status-dot " + getStatusClass(ind.pm25);
        // Orchestrator (for demo, show both cities)
        const avgPM = ((bd.pm25 ?? 0) + (ind.pm25 ?? 0)) / 2;
        renderGauge(
          "orchestrator-gauge",
          avgPM,
          300,
          "Avg PM2.5",
          getAQIColor(avgPM)
        );
        document.getElementById("orchestrator-metrics").innerHTML = `
          <b>Dhaka PM2.5:</b> ${bd.pm25 ?? "--"} µg/m³<br>
          <b>Kolkata PM2.5:</b> ${ind.pm25 ?? "--"} µg/m³<br>
          <b>Cross-Border Coordination:</b> ${
            bd.pm25 && ind.pm25 ? "Active" : "N/A"
          }<br>
        `;
        document.getElementById("orchestrator-status-dot").className =
          "status-dot " + getStatusClass(avgPM);
      }
      function getStatusClass(pm25) {
        if (pm25 == null) return "";
        if (pm25 <= 50) return "healthy";
        if (pm25 <= 100) return "warning";
        if (pm25 <= 150) return "warning";
        if (pm25 <= 200) return "error";
        return "error";
      }
      // --- Button Actions ---
      async function collectData(agent) {
        showSnackbar('Collecting data... <span class="spinner"></span>', true);
        await updateAllData(true);
      }
      async function checkHealth(agent) {
        try {
          const resp = await fetch(endpoints.health(agent));
          const data = await resp.json();
          if (data.status === "healthy") {
            showSnackbar(
              `${
                agent.charAt(0).toUpperCase() + agent.slice(1)
              } agent is healthy!`,
              true
            );
          } else {
            showSnackbar(
              `${
                agent.charAt(0).toUpperCase() + agent.slice(1)
              } agent health warning!`,
              false
            );
          }
        } catch (e) {
          showSnackbar(`Failed to check health for ${agent}.`, false);
        }
      }
      async function coordinate() {
        showSnackbar(
          'Coordinating cross-border response... <span class="spinner"></span>',
          true
        );
        await updateAllData(true);
      }
      // --- Real-time Auto-Refresh ---
      setInterval(() => updateAllData(false), 30000);
      document.getElementById("refresh-btn").onclick = () =>
        updateAllData(true);
      // --- Floating Action Button for mobile ---
      function handleFab() {
        const fab = document.getElementById("fab-refresh");
        if (window.innerWidth < 700) {
          fab.style.display = "flex";
          fab.onclick = () => updateAllData(true);
          fab.onkeydown = (e) => {
            if (e.key === "Enter" || e.key === " ") {
              updateAllData(true);
            }
          };
        } else {
          fab.style.display = "none";
        }
      }
      window.addEventListener("resize", handleFab);
      handleFab();
      // --- Loading Spinner ---
      function showLoading(show) {
        const btns = document.querySelectorAll(".pill-btn, .fab");
        btns.forEach((btn) => {
          if (show) {
            btn.disabled = true;
            btn.style.opacity = 0.7;
          } else {
            btn.disabled = false;
            btn.style.opacity = 1;
          }
        });
      }
      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", function () {
        updateAllData(false);
        // Add color legend
        const legend = document.createElement("div");
        legend.style.margin = "10px auto 0 auto";
        legend.style.maxWidth = "900px";
        legend.style.background = "rgba(255,255,255,0.13)";
        legend.style.borderRadius = "12px";
        legend.style.padding = "10px 18px";
        legend.style.display = "flex";
        legend.style.justifyContent = "center";
        legend.style.gap = "18px";
        legend.style.fontSize = "1em";
        legend.innerHTML = `
          <span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#43a047;"></span>Good (≤50)</span>
          <span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#ffd600;"></span>Moderate (51-100)</span>
          <span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#ff9800;"></span>Unhealthy for Sensitive (101-150)</span>
          <span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#e53935;"></span>Unhealthy (151-200)</span>
          <span style="display:inline-flex;align-items:center;gap:6px;"><span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#6a1b9a;"></span>Very Unhealthy (&gt;200)</span>
        `;
        const mapDiv = document.getElementById("map");
        mapDiv.parentNode.insertBefore(legend, mapDiv.nextSibling);
      });
      function simulateEmergency() {
        const responseDiv = document.getElementById("emergency-response");
        responseDiv.style.display = "block";
        responseDiv.innerHTML = `
          <div style="background:#e53935;color:white;padding:12px 16px;border-radius:10px;font-weight:bold;margin-bottom:10px;">
            🚨 EMERGENCY SCENARIO ACTIVATED
          </div>
          <div style="margin-bottom:10px;">
            <b>Dhaka PM2.5:</b> 287 µg/m³ (HAZARDOUS)<br/>
            <b>Wind:</b> 270° (West to East - Toward India)<br/>
            <b>Response Time:</b> <span style="color:#2ecc71;">47 seconds</span><br/>
            <b>Cross-border coordination:</b> <span style="color:#2ecc71;">ACTIVE</span>
          </div>
          <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:10px;">
            <b>Orchestrator Response:</b><br/>
            <pre style="color:#ffd700;background:none;padding:0;margin:0;">${JSON.stringify(
              {
                status: "success",
                dhaka_pm25: 287,
                wind_direction: 270,
                emergency_level: "red",
                cross_border_impact: true,
                response_time: "47s",
                coordination: "active",
              },
              null,
              2
            )}</pre>
          </div>
        `;
      }
      function showMetrics() {
        const metricsDiv = document.getElementById("metrics-display");
        metricsDiv.style.display =
          metricsDiv.style.display === "none" ? "flex" : "none";
      }
      // Reports Modal Logic
      const reportsLink = document.getElementById("reports-link");
      const reportsModal = document.getElementById("reports-modal");
      const reportsTableArea = document.getElementById("reports-table-area");
      reportsLink.onclick = function (e) {
        e.preventDefault();
        openReportsModal();
      };
      function openReportsModal() {
        reportsModal.style.display = "flex";
        fetchReportsData();
      }
      function closeReportsModal() {
        reportsModal.style.display = "none";
      }
      reportsModal.onclick = function (e) {
        if (e.target === reportsModal) closeReportsModal();
      };
      document.addEventListener("keydown", function (e) {
        if (reportsModal.style.display === "flex" && e.key === "Escape")
          closeReportsModal();
      });
      async function fetchReportsData() {
        reportsTableArea.innerHTML =
          '<div style="color:#ffd600;">Loading reports...</div>';
        try {
          const [bd, ind] = await Promise.all([
            fetch("/api/air-quality/dhaka").then((r) => r.json()),
            fetch("/api/air-quality/kolkata").then((r) => r.json()),
          ]);
          const rows = [];
          if (bd && bd.status === "success") {
            rows.push({
              city: bd.data.city || "Dhaka",
              pm25: bd.data.pm25,
              aqi: bd.data.aqi,
              time: bd.data.timestamp,
              source: "Bangladesh",
            });
          }
          if (ind && ind.status === "success") {
            rows.push({
              city: ind.data.city || "Kolkata",
              pm25: ind.data.pm25,
              aqi: ind.data.aqi,
              time: ind.data.timestamp,
              source: "India",
            });
          }
          let html =
            '<table style="width:100%;border-collapse:collapse;background:rgba(255,255,255,0.08);border-radius:10px;overflow:hidden;">';
          html +=
            '<thead><tr style="color:#ffd600;font-weight:600;"><th>City</th><th>PM2.5 (µg/m³)</th><th>AQI</th><th>Time</th><th>Source</th></tr></thead><tbody>';
          for (const row of rows) {
            html += `<tr style="color:#fff;text-align:center;"><td>${
              row.city
            }</td><td>${row.pm25 ?? "--"}</td><td>${row.aqi ?? "--"}</td><td>${
              row.time ?? "--"
            }</td><td>${row.source}</td></tr>`;
          }
          html += "</tbody></table>";
          reportsTableArea.innerHTML = html;
          window._reportsRows = rows;
        } catch (e) {
          reportsTableArea.innerHTML =
            '<div style="color:#e53935;">Failed to load reports.</div>';
        }
      }
      function downloadCSV() {
        const rows = window._reportsRows || [];
        if (!rows.length) return;
        const header = ["City", "PM2.5 (µg/m³)", "AQI", "Time", "Source"];
        const csv = [header.join(",")]
          .concat(
            rows.map((r) => [r.city, r.pm25, r.aqi, r.time, r.source].join(","))
          )
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "aqms_reports.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      // Settings Modal Logic
      const settingsLink = document.getElementById("settings-link");
      const settingsModal = document.getElementById("settings-modal");
      const settingsForm = document.getElementById("settings-form");
      settingsLink.onclick = function (e) {
        e.preventDefault();
        openSettingsModal();
      };
      function openSettingsModal() {
        settingsModal.style.display = "flex";
        // Load current settings
        document.getElementById("theme-toggle").value =
          localStorage.getItem("aqms_theme") || "light";
        document.getElementById("refresh-interval").value =
          localStorage.getItem("aqms_refresh") || "30000";
        document.getElementById("alert-threshold").value =
          localStorage.getItem("aqms_alert") || "150";
      }
      function closeSettingsModal() {
        settingsModal.style.display = "none";
      }
      settingsModal.onclick = function (e) {
        if (e.target === settingsModal) closeSettingsModal();
      };
      document.addEventListener("keydown", function (e) {
        if (settingsModal.style.display === "flex" && e.key === "Escape")
          closeSettingsModal();
      });
      settingsForm.onsubmit = function (e) {
        e.preventDefault();
        const theme = document.getElementById("theme-toggle").value;
        const refresh = document.getElementById("refresh-interval").value;
        const alert = document.getElementById("alert-threshold").value;
        localStorage.setItem("aqms_theme", theme);
        localStorage.setItem("aqms_refresh", refresh);
        localStorage.setItem("aqms_alert", alert);
        applyTheme(theme);
        setRefreshInterval(Number(refresh));
        window._aqms_alert_threshold = Number(alert);
        closeSettingsModal();
        showSnackbar("Settings saved!", true);
      };
      // Theme logic
      function applyTheme(theme) {
        if (theme === "dark") {
          document.body.style.background =
            "linear-gradient(135deg, #232526 0%, #414345 100%)";
          document.body.style.color = "#fff";
          document
            .querySelectorAll(
              ".glass-card, #reports-modal-content, #settings-modal-content"
            )
            .forEach((el) => {
              el.style.background = "rgba(40,40,50,0.22)";
              el.style.color = "#fff";
            });
          document.querySelectorAll(".pill-btn").forEach((el) => {
            el.style.boxShadow = "0 4px 16px rgba(33,150,243,0.13)";
          });
        } else {
          document.body.style.background =
            "linear-gradient(135deg, #2196F3 0%, #4CAF50 100%)";
          document.body.style.color = "#fff";
          document
            .querySelectorAll(
              ".glass-card, #reports-modal-content, #settings-modal-content"
            )
            .forEach((el) => {
              el.style.background = "rgba(255,255,255,0.13)";
              el.style.color = "#fff";
            });
          document.querySelectorAll(".pill-btn").forEach((el) => {
            el.style.boxShadow = "0 4px 16px rgba(33,150,243,0.13)";
          });
        }
      }
      // On load, apply saved theme
      applyTheme(localStorage.getItem("aqms_theme") || "light");
      // Data refresh interval logic
      let refreshTimer = null;
      let refreshInterval =
        Number(localStorage.getItem("aqms_refresh")) || 30000;
      function setRefreshInterval(ms) {
        if (refreshTimer) clearInterval(refreshTimer);
        refreshInterval = ms;
        refreshTimer = setInterval(() => updateAllData(false), refreshInterval);
      }
      setRefreshInterval(refreshInterval);
      // Alert threshold logic
      window._aqms_alert_threshold =
        Number(localStorage.getItem("aqms_alert")) || 150;
      function highlightAlerts() {
        const threshold = window._aqms_alert_threshold;
        // Bangladesh
        const bd = lastData.bd || {};
        const bdCard = document.querySelector(
          '[aria-label="Bangladesh Agent Panel"]'
        );
        if (bd.pm25 && bd.pm25 > threshold) {
          bdCard.style.boxShadow =
            "0 0 24px 4px #e53935cc, 0 8px 32px 0 rgba(31,38,135,0.18)";
          bdCard.style.border = "2px solid #e53935";
        } else {
          bdCard.style.boxShadow = "";
          bdCard.style.border = "";
        }
        // India
        const ind = lastData.in || {};
        const inCard = document.querySelector(
          '[aria-label="India Agent Panel"]'
        );
        if (ind.pm25 && ind.pm25 > threshold) {
          inCard.style.boxShadow =
            "0 0 24px 4px #e53935cc, 0 8px 32px 0 rgba(31,38,135,0.18)";
          inCard.style.border = "2px solid #e53935";
        } else {
          inCard.style.boxShadow = "";
          inCard.style.border = "";
        }
      }
      // Call highlightAlerts after data update
      const origRenderAgentPanels = renderAgentPanels;
      renderAgentPanels = function () {
        origRenderAgentPanels();
        highlightAlerts();
      };
    </script>
    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_MAPS_API_KEY_PLACEHOLDER&loading=async&callback=initMap"></script>
  </body>
</html>
